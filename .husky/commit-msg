#!/usr/bin/env sh
# Ensure portable, strict shell
set -eu

MSG_FILE="${1:-.git/COMMIT_EDITMSG}"
# Read only the first line and strip CR if present
MSG="$(sed -e 's/\r$//' -n '1p' "$MSG_FILE")"

# Allowed types per Conventional Commits (no PCRE)
TYPE_RE='build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test'

# type(scope)!: subject
if printf '%s' "$MSG" | grep -Eq "^(${TYPE_RE})(\([a-z0-9._-]+\))?(!)?: [^ ].+"; then
  exit 0
fi

printf '%s\n' "[commit-msg] Invalid commit message format." >&2
printf '%s\n' "Expected: <type>(<optional-scope>)<optional-!>: <subject>" >&2
printf '%s\n' "Types: build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test" >&2
exit 1